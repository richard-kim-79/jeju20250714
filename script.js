// Ï†úÏ£º SNS Ïï± Î©îÏù∏ Ïä§ÌÅ¨Î¶ΩÌä∏
class JejuSNS {
    constructor() {
        this.user = null;
        this.posts = [];
        this.selectedCategory = 'all';
        this.searchQuery = '';
        this.apiKey = '';
        this.apiUrl = 'https://jeju20250714-67y4h2vkh-bluewhale2025.vercel.app/api'; // API ÏÑúÎ≤Ñ Ï£ºÏÜå
        this.isLoading = false;
        
        // Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ïÏùò
        this.categories = [
            { id: 'all', name: 'Ï†ÑÏ≤¥', icon: 'üå¥' },
            { id: 'jobs', name: 'Íµ¨Ïù∏Íµ¨ÏßÅ', icon: 'üíº' },
            { id: 'realestate', name: 'Î∂ÄÎèôÏÇ∞', icon: 'üè†' },
            { id: 'events', name: 'ÏßÄÏó≠ÌñâÏÇ¨', icon: 'üéâ' },
            { id: 'policy', name: 'Ï†ïÏ±ÖÏßÄÏõê', icon: 'üìã' },
            { id: 'news', name: 'ÏßÄÏó≠Îâ¥Ïä§', icon: 'üì∞' },
            { id: 'debate', name: 'ÎÇúÏÉÅÌÜ†Î°†', icon: 'üí¨' }
        ];

        // ÏÉòÌîå Îç∞Ïù¥ÌÑ∞
        this.samplePosts = [
            {
                id: 1,
                author: 'Ï†úÏ£ºÏãúÎØº',
                username: '@jejucitizen',
                avatar: 'üë§',
                content: 'Ï†úÏ£ºÏãúÏ≤≠ÏóêÏÑú Ï≤≠ÎÖÑ Ï∞ΩÏóÖ ÏßÄÏõêÍ∏à Ïã†Ï≤≠ Î∞õÍ≥† ÏûàÏñ¥Ïöî! ÏµúÎåÄ 500ÎßåÏõêÍπåÏßÄ ÏßÄÏõêÌï©ÎãàÎã§. ÏûêÏÑ∏Ìïú ÎÇ¥Ïö©ÏùÄ https://jeju.go.kr/startup ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî.',
                category: 'policy',
                timestamp: '2ÏãúÍ∞Ñ Ï†Ñ',
                likes: 24,
                comments: 8,
                retweets: 12,
                hasLink: true,
                image: null
            },
            {
                id: 2,
                author: 'Ï†úÏ£ºÎ∂ÄÎèôÏÇ∞',
                username: '@jejurealty',
                avatar: 'üè†',
                content: 'ÏÑúÍ∑ÄÌè¨Ïãú Ï§ëÎ¨∏Îèô Ìà¨Î£∏ Ï†ÑÏÑ∏ Îß§Î¨º ÎÇòÏôîÏäµÎãàÎã§. Î≥¥Ï¶ùÍ∏à 8Ï≤úÎßåÏõê, Î∞îÎã§ Ï†ÑÎßù Ï¢ãÏùÄ Í≥≥Ïù¥ÏóêÏöî. Ïó∞ÎùΩÏ£ºÏÑ∏Ïöî!',
                category: 'realestate',
                timestamp: '4ÏãúÍ∞Ñ Ï†Ñ',
                likes: 15,
                comments: 23,
                retweets: 6,
                hasLink: false,
                image: null
            },
            {
                id: 3,
                author: 'Ï†úÏ£ºÏó¨ÌñâÏÇ¨',
                username: '@jejutour',
                avatar: '‚úàÔ∏è',
                content: 'Ïù¥Î≤à Ï£ºÎßê ÌïúÎùºÏÇ∞ Îì±Î∞ò Í∞ÄÏù¥Îìú Íµ¨Ìï©ÎãàÎã§. Í≤ΩÎ†• 3ÎÖÑ Ïù¥ÏÉÅ, ÏïàÏ†ÑÍµêÏú° Ïù¥ÏàòÏûê Ïö∞ÎåÄ. ÏùºÎãπ 15ÎßåÏõêÏûÖÎãàÎã§.',
                category: 'jobs',
                timestamp: '6ÏãúÍ∞Ñ Ï†Ñ',
                likes: 31,
                comments: 17,
                retweets: 9,
                hasLink: false,
                image: null
            },
            {
                id: 4,
                author: 'Ï†úÏ£ºÎ¨∏ÌôîÏõê',
                username: '@jejuculture',
                avatar: 'üé≠',
                content: 'Ï†úÏ£º Ï†ÑÌÜµ Ìï¥ÎÖÄ Î¨∏Ìôî Ï≤¥Ìóò ÌñâÏÇ¨Í∞Ä Îã§Ïùå Ï£º ÌÜ†ÏöîÏùº ÏÑ±ÏÇ∞ÏùºÏ∂úÎ¥âÏóêÏÑú Ïó¥Î¶ΩÎãàÎã§. Ï∞∏Í∞ÄÎπÑ Î¨¥Î£å, ÏÇ¨Ï†Ñ Ïã†Ï≤≠ ÌïÑÏàò!',
                category: 'events',
                timestamp: '8ÏãúÍ∞Ñ Ï†Ñ',
                likes: 67,
                comments: 34,
                retweets: 28,
                hasLink: false,
                image: null
            }
        ];

        this.selectedCategories = new Set(['all']); // Îã§Ï§ë ÏÑ†ÌÉù ÏßÄÏõê
        this.init();
    }

    async init() {
        this.loadUserFromStorage();
        this.setupEventListeners();
        await this.loadApiKeyFromStorage();
        
        // ÏûêÎèô Î°úÍ∑∏Ïù∏ÏùÄ API ÌÇ§Í∞Ä ÏûàÏùÑ ÎïåÎßå Ïã§Ìñâ
        if (!this.user && this.apiKey) {
            this.handleLogin('email');
        }
        
        await this.fetchPosts();
        this.renderPosts();
        
        // UI ÏóÖÎç∞Ïù¥Ìä∏ (Î°úÍ∑∏Ïù∏ Î≤ÑÌäº ÌëúÏãúÎ•º ÏúÑÌï¥)
        this.updateUserInterface();
    }

    setupEventListeners() {
        // Î°úÍ∑∏Ïù∏ Î≤ÑÌäº
        // loginBtn Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞ Ï†úÍ±∞ (updateUserInterfaceÏóêÏÑúÎßå Ïó∞Í≤∞)

        // Î°úÍ∑∏Ïù∏ Î™®Îã¨ Îã´Í∏∞
        document.getElementById('closeLoginModal').addEventListener('click', () => {
            this.hideLoginModal();
        });

        // Î°úÍ∑∏Ïù∏ ÏòµÏÖòÎì§
        document.getElementById('emailLogin').addEventListener('click', () => this.handleLogin('email'));
        document.getElementById('googleLogin').addEventListener('click', () => this.handleLogin('google'));
        document.getElementById('naverLogin').addEventListener('click', () => this.handleLogin('naver'));
        document.getElementById('kakaoLogin').addEventListener('click', () => this.handleLogin('kakao'));

        // API Î™®Îã¨ Í¥ÄÎ†®
        document.getElementById('closeApiModal').addEventListener('click', () => {
            this.hideApiModal();
        });

        document.getElementById('generateApiKey').addEventListener('click', () => {
            this.generateApiKey();
        });

        // API ÌÇ§ ÏûÖÎ†• Î∞òÏòÅ
        const apiKeyInput = document.getElementById('apiKeyInput');
        if (apiKeyInput) {
            apiKeyInput.addEventListener('input', (e) => {
                this.apiKey = e.target.value;
                localStorage.setItem('jejuApiKey', this.apiKey);
            });
        }

        // Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤ÑÌäºÎì§
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const cat = e.target.closest('.category-btn').dataset.category;
                if (cat === 'all') {
                    this.selectedCategories = new Set(['all']);
                } else {
                    if (this.selectedCategories.has('all')) this.selectedCategories.delete('all');
                    if (this.selectedCategories.has(cat)) {
                        this.selectedCategories.delete(cat);
                        if (this.selectedCategories.size === 0) this.selectedCategories.add('all');
                    } else {
                        this.selectedCategories.add(cat);
                    }
                }
                this.updateCategoryButtons();
                this.renderPosts();
            });
        });

        // Í≤ÄÏÉâ
        document.getElementById('searchInput').addEventListener('input', (e) => {
            this.searchQuery = e.target.value;
            this.renderPosts();
        });

        // Í≤åÏãúÍ∏Ä ÏûëÏÑ±
        document.getElementById('submitPost').addEventListener('click', () => {
            this.submitPost();
        });

        // Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú
        document.getElementById('imageUpload').addEventListener('change', (e) => {
            this.handleImageUpload(e);
        });

        // Ïù¥ÎØ∏ÏßÄ Ï†úÍ±∞
        document.getElementById('removeImage').addEventListener('click', () => {
            this.removeImage();
        });

        // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
        document.getElementById('loginModal').addEventListener('click', (e) => {
            if (e.target.id === 'loginModal') {
                this.hideLoginModal();
            }
        });

        document.getElementById('apiModal').addEventListener('click', (e) => {
            if (e.target.id === 'apiModal') {
                this.hideApiModal();
            }
        });

        // Í∞úÏù∏Ï†ïÎ≥¥ Î™®Îã¨ Í¥ÄÎ†® Ïù¥Î≤§Ìä∏
        document.getElementById('closeProfileModal').addEventListener('click', () => {
            this.hideProfileModal();
        });

        document.getElementById('saveProfile').addEventListener('click', () => {
            this.saveProfile();
        });

        document.getElementById('cancelProfile').addEventListener('click', () => {
            this.hideProfileModal();
        });

        document.getElementById('profileModal').addEventListener('click', (e) => {
            if (e.target.id === 'profileModal') {
                this.hideProfileModal();
            }
        });
    }

    async loadApiKeyFromStorage() {
        const savedKey = localStorage.getItem('jejuApiKey');
        if (savedKey) {
            this.apiKey = savedKey;
            const apiKeyInput = document.getElementById('apiKeyInput');
            if (apiKeyInput) apiKeyInput.value = savedKey;
        } else {
            // API ÌÇ§Í∞Ä ÏóÜÏúºÎ©¥ Î™®Îã¨ ÏûêÎèô ÏïàÎÇ¥
            setTimeout(() => this.showApiModal(), 1000);
        }
    }

    async fetchPosts(scrollToTop = false) {
        if (!this.apiKey) {
            this.posts = [];
            this.renderPosts();
            this.showNotification('API ÌÇ§Î•º ÏûÖÎ†•ÌïòÍ±∞ÎÇò ÏÉùÏÑ±ÌïòÏÑ∏Ïöî.','error');
            return;
        }
        this.isLoading = true;
        this.renderPosts();
        try {
            const res = await fetch(`${this.apiUrl}/posts`, {
                headers: { 'x-api-key': this.apiKey }
            });
            if (!res.ok) throw new Error('API Ïò§Î•ò: ' + res.status);
            this.posts = await res.json();
        } catch (e) {
            this.posts = [];
            this.showNotification('Í≤åÏãúÍ∏Ä Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: ' + e.message, 'error');
        }
        this.isLoading = false;
        this.renderPosts();
        if (scrollToTop) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    loadPosts() {
        const savedPosts = localStorage.getItem('jejuPosts');
        if (savedPosts) {
            this.posts = JSON.parse(savedPosts);
        } else {
            this.posts = [...this.samplePosts];
            this.savePosts();
        }
    }

    savePosts() {
        localStorage.setItem('jejuPosts', JSON.stringify(this.posts));
    }

    loadUserFromStorage() {
        const savedUser = localStorage.getItem('jejuUser');
        if (savedUser) {
            this.user = JSON.parse(savedUser);
            this.updateUserInterface();
        }
    }

    saveUserToStorage() {
        if (this.user) {
            localStorage.setItem('jejuUser', JSON.stringify(this.user));
        } else {
            localStorage.removeItem('jejuUser');
        }
    }

    showLoginModal() {
        document.getElementById('loginModal').classList.remove('hidden');
        document.getElementById('loginModal').classList.add('modal-enter');
    }

    hideLoginModal() {
        document.getElementById('loginModal').classList.add('hidden');
    }

    showApiModal() {
        document.getElementById('apiModal').classList.remove('hidden');
        document.getElementById('apiModal').classList.add('modal-enter');
        // Î≥µÏÇ¨ Î≤ÑÌäº ÎèôÏ†Å Ï∂îÍ∞Ä
        setTimeout(() => {
            let copyBtn = document.getElementById('copyApiKeyBtn');
            if (!copyBtn) {
                const input = document.getElementById('apiKeyInput');
                const btn = document.createElement('button');
                btn.id = 'copyApiKeyBtn';
                btn.textContent = 'Î≥µÏÇ¨';
                btn.className = 'px-2 py-1 text-xs bg-gray-200 rounded hover:bg-gray-300 ml-2';
                btn.onclick = () => {
                    navigator.clipboard.writeText(input.value);
                    this.showNotification('API ÌÇ§Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!');
                };
                input.parentNode.appendChild(btn);
            }
        }, 200);
    }

    hideApiModal() {
        document.getElementById('apiModal').classList.add('hidden');
    }

    showProfileModal() {
        if (!this.user) return;
        
        console.log('Í∞úÏù∏Ï†ïÎ≥¥ Î™®Îã¨ Ïó¥Í∏∞ ÏãúÎèÑ');
        
        // ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î°ú Î™®Îã¨ ÌïÑÎìú Ï±ÑÏö∞Í∏∞
        document.getElementById('profileAvatar').textContent = this.user.avatar;
        document.getElementById('profileName').textContent = this.user.name;
        document.getElementById('profileUsername').textContent = this.user.username;
        document.getElementById('profileDisplayName').value = this.user.name;
        document.getElementById('profileUsernameInput').value = this.user.username.replace('@', '');
        document.getElementById('profileEmail').value = this.user.email || '';
        
        const modal = document.getElementById('profileModal');
        modal.classList.remove('hidden');
        console.log('Í∞úÏù∏Ï†ïÎ≥¥ Î™®Îã¨ Ïó¥Î¶º:', modal.classList.contains('hidden'));
        
        // Î≤ÑÌäºÏù¥ Î≥¥Ïù¥ÎäîÏßÄ ÌôïÏù∏
        const saveBtn = document.getElementById('saveProfile');
        const cancelBtn = document.getElementById('cancelProfile');
        console.log('Ï†ÄÏû• Î≤ÑÌäº:', saveBtn);
        console.log('Ï∑®ÏÜå Î≤ÑÌäº:', cancelBtn);
    }

    hideProfileModal() {
        document.getElementById('profileModal').classList.add('hidden');
    }

    async saveProfile() {
        if (!this.user) return;
        
        const displayName = document.getElementById('profileDisplayName').value.trim();
        const username = document.getElementById('profileUsernameInput').value.trim();
        const email = document.getElementById('profileEmail').value.trim();
        
        if (!displayName || !username) {
            this.showNotification('ÌëúÏãú Ïù¥Î¶ÑÍ≥º ÏÇ¨Ïö©ÏûêÎ™ÖÏùÄ ÌïÑÏàòÏûÖÎãàÎã§.', 'error');
            return;
        }
        
        // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        this.user.name = displayName;
        this.user.username = `@${username}`;
        this.user.email = email;
        
        // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
        this.saveUserToStorage();
        
        // UI ÏóÖÎç∞Ïù¥Ìä∏
        this.updateUserInterface();
        
        this.hideProfileModal();
        this.showNotification('Í∞úÏù∏Ï†ïÎ≥¥Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
    }

    handleLogin(provider) {
        // Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑúÎäî OAuth Ïù∏Ï¶ùÏùÑ ÏÇ¨Ïö©Ìï¥Ïïº Ìï©ÎãàÎã§
        this.user = {
            name: 'Ï†úÏ£ºÎèÑÎØº',
            username: '@jejuuser',
            userId: 'jejuuser', // userId Ï∂îÍ∞Ä
            avatar: 'üë§',
            email: 'user@jeju.com',
            provider: provider
        };
        
        this.saveUserToStorage();
        this.updateUserInterface();
        this.hideLoginModal();
        
        // ÌôòÏòÅ Î©îÏãúÏßÄ
        this.showNotification('JeJu SNSÏóê Ïò§Ïã† Í≤ÉÏùÑ ÌôòÏòÅÌï©ÎãàÎã§! üçä');
    }

    handleLogout() {
        this.user = null;
        this.apiKey = '';
        this.saveUserToStorage();
        this.updateUserInterface();
        this.showNotification('Î°úÍ∑∏ÏïÑÏõÉÎêòÏóàÏäµÎãàÎã§.');
    }

    updateUserInterface() {
        const userSection = document.getElementById('userSection');
        const postForm = document.getElementById('postForm');

        if (this.user) {
            userSection.innerHTML = `
                <div class="flex items-center space-x-4">
                    <button
                        onclick="jejuSNS.showApiModal()"
                        class="flex items-center space-x-2 px-3 py-1.5 text-sm text-blue-600 hover:bg-blue-50 rounded-full transition-colors"
                    >
                        <i data-lucide="key" class="w-4 h-4"></i>
                        <span>API</span>
                    </button>
                    <div class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 rounded-full px-2 py-1 transition-colors" onclick="jejuSNS.showProfileModal()">
                        <span class="text-lg">${this.user.avatar}</span>
                    </div>
                    <button
                        onclick="jejuSNS.handleLogout()"
                        class="flex items-center space-x-2 px-3 py-1.5 text-sm text-red-600 hover:bg-red-50 rounded-full transition-colors"
                    >
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                        <span>Î°úÍ∑∏ÏïÑÏõÉ</span>
                    </button>
                </div>
            `;
            postForm.classList.remove('hidden');
        } else {
            userSection.innerHTML = `
                <button
                    id="loginBtn"
                    class="bg-orange-600 text-white text-sm px-4 py-2 rounded-full hover:bg-orange-700 transition-colors font-medium shadow-md hover:shadow-lg transform hover:scale-105"
                >
                    Î°úÍ∑∏Ïù∏
                </button>
            `;
            postForm.classList.add('hidden');
            // Î°úÍ∑∏Ïù∏ Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Îã§Ïãú Ïó∞Í≤∞ (Ïó¨Í∏∞ÏÑúÎßå!)
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                loginBtn.addEventListener('click', () => {
                    this.showLoginModal();
                });
            }
        }
        lucide.createIcons();
    }

    async generateApiKey() {
        try {
            const userId = this.user ? this.user.username.replace('@','') : 'guest';
            const userName = this.user ? this.user.name : 'Í≤åÏä§Ìä∏';
            const res = await fetch(`${this.apiUrl}/keys`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, userName })
            });
            if (!res.ok) throw new Error('API Ïò§Î•ò: ' + res.status);
            const data = await res.json();
            this.apiKey = data.key;
            document.getElementById('apiKeyInput').value = data.key;
            document.getElementById('apiExample').textContent = `GET /api/posts?key=${data.key}`;
            localStorage.setItem('jejuApiKey', data.key);
            this.showNotification('API ÌÇ§Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!');
        } catch (e) {
            this.showNotification('API ÌÇ§ ÏÉùÏÑ± Ïã§Ìå®: ' + e.message);
        }
    }

    selectCategory(category) {
        this.selectedCategory = category;
        
        // Î™®Îì† Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤ÑÌäºÏóêÏÑú active ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-orange-100', 'text-orange-600', 'border-orange-300');
            btn.classList.add('hover:bg-gray-100', 'border-transparent');
        });
        
        // ÏÑ†ÌÉùÎêú Î≤ÑÌäºÏóê active ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
        const selectedBtn = document.querySelector(`[data-category="${category}"]`);
        if (selectedBtn) {
            selectedBtn.classList.add('active', 'bg-orange-100', 'text-orange-600', 'border-orange-300');
            selectedBtn.classList.remove('hover:bg-gray-100', 'border-transparent');
        }
        
        this.renderPosts();
    }

    handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        // Ìè≠ÎÑìÏùÄ ÌôïÏû•Ïûê/ÌÉÄÏûÖ ÌóàÏö© (Ïä§ÎßàÌä∏Ìè∞ Ï¥¨ÏòÅ Ïù¥ÎØ∏ÏßÄ Ìè¨Ìï®)
        const allowedTypes = [
            'image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/bmp',
            'image/heic', 'image/heif', 'image/jpg', 'image/x-icon', 'image/svg+xml'
        ];
        const allowedExt = [
            '.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.heic', '.heif', '.ico', '.svg'
        ];
        const fileExt = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
        if (!allowedTypes.includes(file.type) && !allowedExt.includes(fileExt)) {
            this.showNotification('Ïù¥ÎØ∏ÏßÄ ÌååÏùº(jpg, jpeg, png, gif, webp, bmp, heic, heif, ico, svg)Îßå ÏóÖÎ°úÎìúÌï† Ïàò ÏûàÏäµÎãàÎã§.','error');
            event.target.value = '';
            this.removeImage();
            return;
        }
        // 10MB Ï†úÌïú
        if (file.size > 10 * 1024 * 1024) {
            this.showNotification('Ïù¥ÎØ∏ÏßÄ Ïö©ÎüâÏùÄ 10MB Ïù¥ÌïòÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.','error');
            event.target.value = '';
            this.removeImage();
            return;
        }
        // ÏóÖÎ°úÎìú ÏßÑÌñâ ÌëúÏãú
        const preview = document.getElementById('imagePreview');
        preview.classList.remove('hidden');
        preview.innerHTML = '<div class="flex items-center justify-center h-32 text-orange-500">Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞Î•º Ï§ÄÎπÑ Ï§ë...</div>';
        const reader = new FileReader();
        reader.onloadstart = () => {
            preview.innerHTML = '<div class="flex items-center justify-center h-32 text-orange-500 animate-pulse">Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞Î•º Ï§ÄÎπÑ Ï§ë...</div>';
        };
        reader.onprogress = (e) => {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                preview.innerHTML = `<div class='flex flex-col items-center justify-center h-32 text-orange-500'><span>ÏóÖÎ°úÎìú Ï§ÄÎπÑ Ï§ë... ${percent}%</span><div class='w-32 bg-gray-200 rounded-full h-2 mt-2'><div class='bg-orange-400 h-2 rounded-full' style='width:${percent}%;'></div></div></div>`;
            }
        };
        reader.onload = (e) => {
            preview.innerHTML = `<img id="previewImg" src="${e.target.result}" alt="ÏóÖÎ°úÎìúÎêú Ïù¥ÎØ∏ÏßÄ" class="max-w-full h-auto rounded-lg border max-h-60">` +
                `<button id="removeImage" class="absolute top-2 right-2 bg-black bg-opacity-50 text-white rounded-full p-1 hover:bg-opacity-70"><i data-lucide="x" class="w-4 h-4"></i></button>`;
            document.getElementById('removeImage').addEventListener('click', () => {
                this.removeImage();
            });
        };
        reader.onerror = () => {
            this.showNotification('Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ Ïã§Ìå®','error');
            this.removeImage();
        };
        reader.readAsDataURL(file);
    }

    removeImage() {
        const preview = document.getElementById('imagePreview');
        preview.classList.add('hidden');
        preview.innerHTML = '';
        document.getElementById('imageUpload').value = '';
    }

    async submitPost() {
        const content = document.getElementById('postContent').value.trim();
        const category = document.getElementById('postCategory').value;
        const imagePreview = document.getElementById('imagePreview');
        const image = imagePreview.classList.contains('hidden') ? null : document.getElementById('previewImg').src;
        if (!content) {
            this.showNotification('ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.', 'error');
            return;
        }
        if (content.length > 1000) {
            this.showNotification('ÎÇ¥Ïö©ÏùÄ 1000Ïûê Ïù¥ÎÇ¥Î°ú ÏûÖÎ†•ÌïòÏÑ∏Ïöî.', 'error');
            return;
        }
        if (!category) {
            this.showNotification('Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.', 'error');
            return;
        }
        if (!this.apiKey) {
            this.showNotification('API ÌÇ§Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§.', 'error');
            return;
        }
        try {
            const res = await fetch(`${this.apiUrl}/posts`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': this.apiKey
                },
                body: JSON.stringify({
                    content,
                    category,
                    image
                })
            });
            if (!res.ok) throw new Error('API Ïò§Î•ò: ' + res.status);
            await this.fetchPosts(true); // ÏûëÏÑ± ÌõÑ ÏûêÎèô Ïä§ÌÅ¨Î°§
            document.getElementById('postContent').value = '';
            this.removeImage();
            this.showNotification('Í≤åÏãúÍ∏ÄÏù¥ ÏûëÏÑ±ÎêòÏóàÏäµÎãàÎã§!', 'success');
        } catch (e) {
            this.showNotification('Í≤åÏãúÍ∏Ä ÏûëÏÑ± Ïã§Ìå®: ' + e.message, 'error');
        }
    }

    handleLinkClick(content) {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const urls = content.match(urlRegex);
        if (urls) {
            window.open(urls[0], '_blank');
        }
    }

    updateCategoryButtons() {
        document.querySelectorAll('.category-btn').forEach(btn => {
            const cat = btn.dataset.category;
            if (this.selectedCategories.has(cat)) {
                btn.classList.add('active', 'bg-orange-100', 'text-orange-600', 'border-orange-300');
                btn.classList.remove('hover:bg-gray-100', 'border-transparent');
            } else {
                btn.classList.remove('active', 'bg-orange-100', 'text-orange-600', 'border-orange-300');
                btn.classList.add('hover:bg-gray-100', 'border-transparent');
            }
        });
    }

    async renderPosts() {
        const feed = document.getElementById('feed');
        if (this.isLoading) {
            feed.innerHTML = '<div class="p-6 text-center text-gray-500"><span class="loading-spinner inline-block"></span> Î∂àÎü¨Ïò§Îäî Ï§ë...</div>';
            return;
        }
        // ÏÉàÎ°úÍ≥†Ïπ® Î≤ÑÌäº Ï∂îÍ∞Ä
        feed.innerHTML = `<div class='flex justify-end p-2'><button id='refreshFeedBtn' class='text-gray-400 hover:text-gray-600 px-2 py-1 text-xs rounded transition-colors flex items-center gap-1'><span>üîÑ</span> ÏÉàÎ°úÍ≥†Ïπ®</button></div>`;
        // Í≥†Í∏â Í≤ÄÏÉâ UI Ï∂îÍ∞Ä
        feed.innerHTML += `<div class='flex flex-wrap gap-2 items-center p-2 mb-2'>
            <span class='text-xs text-gray-500'>Ïπ¥ÌÖåÍ≥†Î¶¨ Îã§Ï§ë ÏÑ†ÌÉù Í∞ÄÎä•</span>
            <input id='advancedSearchInput' type='text' placeholder='ÌÇ§ÏõåÎìúÎ°ú Ï∂îÍ∞Ä Í≤ÄÏÉâ...' class='border px-2 py-1 rounded text-sm ml-2' style='min-width:160px;'/>
        </div>`;
        // ÌïÑÌÑ∞ÎßÅÎêú Í≤åÏãúÍ∏Ä Í∞ÄÏ†∏Ïò§Í∏∞
        const keyword = (document.getElementById('advancedSearchInput')?.value || '').toLowerCase();
        const filteredPosts = this.posts.filter(post => {
            const matchesCategory = this.selectedCategories.has('all') || this.selectedCategories.has(post.category);
            const matchesSearch = (this.searchQuery === '' || post.content.toLowerCase().includes(this.searchQuery.toLowerCase()) || post.author.toLowerCase().includes(this.searchQuery.toLowerCase()));
            const matchesAdvanced = !keyword || post.content.toLowerCase().includes(keyword) || post.author.toLowerCase().includes(keyword);
            return matchesCategory && matchesSearch && matchesAdvanced;
        });

        if (filteredPosts.length === 0) {
            feed.innerHTML += `
                <div class="p-6 text-center text-gray-500">
                    <i data-lucide="map-pin" class="w-10 h-10 mx-auto mb-3 text-gray-300"></i>
                    <p class="text-base">ÏïÑÏßÅ Í≤åÏãúÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.</p>
                    <p class="text-xs mt-1">Ï≤´ Î≤àÏß∏ JeJu Ï†ïÎ≥¥Î•º Í≥µÏú†Ìï¥Î≥¥ÏÑ∏Ïöî!<br>üçä JeJuÏóêÏÑúÎßå Î≥º Ïàò ÏûàÎäî ÍøÄÌåÅ, ÏÜåÏãù, ÏùºÏûêÎ¶¨, Î∂ÄÎèôÏÇ∞, ÌñâÏÇ¨ Îì± Î¨¥ÏóáÏù¥Îì† ÌôòÏòÅÌï©ÎãàÎã§.</p>
                </div>
            `;
        } else {
            feed.innerHTML += filteredPosts.map(post => this.renderPost(post)).join('');
        }
        // ÏÉàÎ°úÍ≥†Ïπ® Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
        const refreshBtn = document.getElementById('refreshFeedBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => this.fetchPosts(true));
        }
        // Í≥†Í∏â Í≤ÄÏÉâ ÏûÖÎ†• Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
        const advInput = document.getElementById('advancedSearchInput');
        if (advInput) {
            advInput.addEventListener('input', () => this.renderPosts());
        }
        lucide.createIcons();
        // ÎåìÍ∏Ä/Ï¢ãÏïÑÏöî Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
        document.querySelectorAll('.like-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const postId = btn.dataset.postId;
                await this.toggleLike(postId, btn);
            });
        });
        document.querySelectorAll('.comment-toggle-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const postId = btn.dataset.postId;
                const commentBox = document.getElementById(`commentBox-${postId}`);
                if (commentBox) {
                    commentBox.classList.toggle('hidden');
                }
            });
        });
        document.querySelectorAll('.comment-submit-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const postId = btn.dataset.postId;
                const input = document.getElementById(`commentInput-${postId}`);
                const comment = input.value.trim();
                if (!comment) return;
                await this.submitComment(postId, comment);
                input.value = '';
            });
        });
        document.querySelectorAll('.comment-delete-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const postId = btn.dataset.postId;
                const commentId = btn.dataset.commentId;
                if (confirm('ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    await this.deleteComment(postId, commentId);
                }
            });
        });
    }

    renderPost(post) {
        const category = this.categories.find(cat => cat.id === post.category);
        const categoryDisplay = category ? `${category.icon} ${category.name}` : '';
        
        const contentWithLinks = post.hasLink ? 
            post.content.replace(/(https?:\/\/[^\s]+)/g, '<span class="link-text" onclick="jejuSNS.handleLinkClick(\'' + post.content + '\')">$1</span>') :
            post.content;

        // ÎåìÍ∏Ä Î™©Î°ù Î†åÎçîÎßÅ (ÏÇ≠Ï†ú Î≤ÑÌäº Ìè¨Ìï®)
        const commentsHtml = (post.comments && post.comments.length > 0) ?
            `<div class='mt-2 bg-gray-50 rounded p-2 text-xs'>${post.comments.map(c => `<div class='mb-1 flex items-center justify-between'><span><b>${c.author}</b>: ${c.content}</span>${(this.user && (this.user.userId === c.userId || this.user.userId === 'admin')) ? `<button class='comment-delete-btn text-red-400 ml-2' data-post-id='${post.id}' data-comment-id='${c.id}'>ÏÇ≠Ï†ú</button>` : ''}</div>`).join('')}</div>` : '';
        // ÎåìÍ∏Ä ÏûÖÎ†•Ï∞Ω
        const commentInputHtml = `<div class='flex mt-2 gap-2'><input id='commentInput-${post.id}' type='text' placeholder='ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî' class='flex-1 border rounded px-2 py-1 text-xs'/><button class='comment-submit-btn text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded' data-post-id='${post.id}'>Îì±Î°ù</button></div>`;
        // Ï¢ãÏïÑÏöî Î≤ÑÌäº
        const liked = post.likedUsers && this.user && post.likedUsers.includes(this.user.userId);
        // ÎåìÍ∏Ä ÌÜ†Í∏Ä Î∞ïÏä§
        const commentBoxHtml = `<div id='commentBox-${post.id}' class='hidden'>${commentsHtml}${commentInputHtml}</div>`;
        return `
            <div class="post-card bg-white border-b border-gray-200 p-3 hover:bg-gray-50 transition-colors fade-in" style="animation: fadeIn 0.5s;">
                <div class="flex space-x-2">
                    <div class="text-lg">${post.avatar}</div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-1 mb-1">
                            <span class="text-sm font-bold text-gray-900">${post.author}</span>
                            <span class="text-xs text-gray-500">${post.username}</span>
                            <span class="text-xs text-gray-500">¬∑</span>
                            <span class="text-xs text-gray-500">${post.timestamp}</span>
                            <span class="text-xs px-1.5 py-0.5 bg-blue-100 text-blue-800 rounded-full">
                                ${categoryDisplay}
                            </span>
                        </div>
                        
                        <div class="text-sm text-gray-900 mb-2">
                            ${contentWithLinks}
                        </div>

                        ${post.image ? `
                            <div class="mb-2">
                                <img 
                                    src="${post.image}" 
                                    alt="Í≤åÏãúÍ∏Ä Ïù¥ÎØ∏ÏßÄ" 
                                    class="max-w-full h-auto rounded-lg border max-h-48"
                                >
                            </div>
                        ` : ''}

                        <div class="flex items-center space-x-6 text-gray-500 text-sm">
                            <button class="like-btn flex items-center space-x-1 hover:text-red-600 transition-colors ${liked ? 'text-red-600' : ''}" data-post-id="${post.id}">
                                <i data-lucide="heart" class="w-4 h-4"></i>
                                <span class="text-xs">${post.likes || 0}</span>
                            </button>
                            <button class="comment-toggle-btn flex items-center space-x-1 hover:text-blue-600 transition-colors" data-post-id="${post.id}">
                                <i data-lucide="message-circle" class="w-4 h-4"></i>
                                <span class="text-xs">ÎåìÍ∏Ä</span>
                            </button>
                        </div>
                        ${commentBoxHtml}
                    </div>
                </div>
            </div>
        `;
    }

    async toggleLike(postId, btn) {
        if (!this.apiKey) {
            this.showNotification('API ÌÇ§Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§.', 'error');
            return;
        }
        try {
            const res = await fetch(`${this.apiUrl}/posts/${postId}/like`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-api-key': this.apiKey }
            });
            if (!res.ok) throw new Error('API Ïò§Î•ò: ' + res.status);
            await this.fetchPosts();
        } catch (e) {
            this.showNotification('Ï¢ãÏïÑÏöî Ï≤òÎ¶¨ Ïã§Ìå®: ' + e.message, 'error');
        }
    }

    async submitComment(postId, comment) {
        if (!this.apiKey) {
            this.showNotification('API ÌÇ§Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§.', 'error');
            return;
        }
        try {
            const res = await fetch(`${this.apiUrl}/posts/${postId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-api-key': this.apiKey },
                body: JSON.stringify({ comment })
            });
            if (!res.ok) throw new Error('API Ïò§Î•ò: ' + res.status);
            await this.fetchPosts();
        } catch (e) {
            this.showNotification('ÎåìÍ∏Ä ÏûëÏÑ± Ïã§Ìå®: ' + e.message, 'error');
        }
    }

    async deleteComment(postId, commentId) {
        if (!this.apiKey) {
            this.showNotification('API ÌÇ§Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§.', 'error');
            return;
        }
        try {
            const res = await fetch(`${this.apiUrl}/posts/${postId}/comments/${commentId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json', 'x-api-key': this.apiKey }
            });
            if (!res.ok) throw new Error('API Ïò§Î•ò: ' + res.status);
            await this.fetchPosts();
        } catch (e) {
            this.showNotification('ÎåìÍ∏Ä ÏÇ≠Ï†ú Ïã§Ìå®: ' + e.message, 'error');
        }
    }

    showNotification(message, type = 'success') {
        // Í∞ÑÎã®Ìïú ÏïåÎ¶º ÌëúÏãú
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 fade-in ${type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    goToHome() {
        // Î™®Îì† Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù Ìï¥Ï†úÌïòÍ≥† 'Ï†ÑÏ≤¥'Î°ú ÏÑ§Ï†ï
        this.selectedCategories = new Set(['all']);
        this.searchQuery = '';
        
        // Í≤ÄÏÉâ ÏûÖÎ†•Ï∞Ω Ï¥àÍ∏∞Ìôî
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.value = '';
        }
        
        // Í≥†Í∏â Í≤ÄÏÉâ ÏûÖÎ†•Ï∞Ω Ï¥àÍ∏∞Ìôî
        const advancedSearchInput = document.getElementById('advancedSearchInput');
        if (advancedSearchInput) {
            advancedSearchInput.value = '';
        }
        
        // Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        this.updateCategoryButtons();
        
        // Í≤åÏãúÍ∏Ä Îã§Ïãú Î†åÎçîÎßÅ
        this.renderPosts();
        
        // ÌéòÏù¥ÏßÄ ÏÉÅÎã®ÏúºÎ°ú Ïä§ÌÅ¨Î°§
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // ÌôàÏúºÎ°ú Ïù¥Îèô ÏïåÎ¶º
        this.showNotification('ÌôàÏúºÎ°ú Ïù¥ÎèôÌñàÏäµÎãàÎã§ üè†');
    }
}

// Ïï± Ï¥àÍ∏∞Ìôî
let jejuSNS;
document.addEventListener('DOMContentLoaded', () => {
    jejuSNS = new JejuSNS();
}); 